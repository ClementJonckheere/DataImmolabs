{% extends 'base.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/dashboard.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ asset('js/dashboard.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block body %}
    <div class="container">
        <h1>Dashboard Immobilier</h1>
        <div class="documentation-container">
            <a href="{{ path('api_doc') }}">Documentation des différentes APIs</a>
        </div>
        <div class="kpi-container">
            {% for key, value in kpi %}
                <div class="kpi-card">
                    <h3>{{ key|replace({'_': ' '})|capitalize }}</h3>
                    <p>
                        {% if 'valeur' in key or 'prix' in key %}
                            {{ value|number_format('2', ',', ' ') }} €
                            {% if 'm2' in key %}/m²{% endif %}
                        {% elseif 'surface' in key %}
                            {{ value|number_format('2', ',', ' ') }} m²
                        {% elseif 'date' in key %}
                            {{ value }}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </p>
                </div>
            {% endfor %}
        </div>

        <div class="mb-4">
            <label for="ville-select">Rechercher une ville :</label>
            <select id="ville-select" name="ville" style="width: 300px;">
                <option value="">-- Toutes les villes --</option>
            </select>
        </div>

        {% if ville and transactions_ville|length > 0 %}
            <h2>Transactions à {{ ville }}</h2>
            <table>
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Valeur foncière (€)</th>
                    <th>Surface bâtie (m²)</th>

                </tr>
                </thead>
                <tbody>
                {% for tx in transactions_ville %}
                    <tr>
                        <td>{{ tx.date }}</td>
                        <td>{{ tx.valeur_fonciere|number_format(0, ',', ' ') }}</td>
                        <td>{{ tx.surface_reelle_bati|number_format(0, ',', ' ') }}</td>

                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}

        <h2>Top 10 des hausses de population ({{ annees_comparees }})</h2>
        <table>
            <thead>
            <tr>
                <th>Ville</th>
                <th>Code INSEE</th>
                <th>Population 2021</th>
                <th>Population 2022</th>
                <th>Variation</th>
                <th>Croissance (%)</th>
            </tr>
            </thead>
            <tbody>
            {% for item in topProgressions %}
                <tr>
                    <td>{{ item.ville }}</td>
                    <td>{{ item.code_insee }}</td>
                    <td>{{ item.pop_2021|number_format(0, ',', ' ') }}</td>
                    <td>{{ item.pop_2022|number_format(0, ',', ' ') }}</td>
                    <td>{{ item.variation|number_format(0, ',', ' ') }}</td>
                    <td>{{ item.croissance_percent }} %</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <h2>Top 10 des baisses de population ({{ annees_comparees }})</h2>
        <table>
            <thead>
            <tr>
                <th>Ville</th>
                <th>Code INSEE</th>
                <th>Population 2021</th>
                <th>Population 2022</th>
                <th>Variation</th>
                <th>Déclin (%)</th>
            </tr>
            </thead>
            <tbody>
            {% for item in topDeclines %}
                <tr>
                    <td>{{ item.ville }}</td>
                    <td>{{ item.code_insee }}</td>
                    <td>{{ item.pop_2021|number_format(0, ',', ' ') }}</td>
                    <td>{{ item.pop_2022|number_format(0, ',', ' ') }}</td>
                    <td>{{ item.variation|number_format(0, ',', ' ') }}</td>
                    <td>{{ item.croissance_percent }} %</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <h2>Répartition des transactions selon les tranches de prix</h2>
        <canvas id="priceRangeChart" width="400" height="150"></canvas>

        {# Données injectées pour JS #}
        <script type="application/json" id="chart-data-labels">
            {{ price_distribution.distribution|map(p => p.range)|json_encode|raw }}
        </script>
        <script type="application/json" id="chart-data-values">
            {{ price_distribution.distribution|map(p => p.count)|json_encode|raw }}
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const select = $('#ville-select');
                const params = new URLSearchParams(window.location.search);
                const selectedVille = params.get("ville");

                try {
                    const response = await fetch("/api/villes");
                    const data = await response.json();

                    data.villes.forEach(ville => {
                        const option = new Option(ville, ville, false, ville === selectedVille);
                        select.append(option);
                    });

                    select.select2({
                        placeholder: "Choisissez une ville",
                        allowClear: true
                    });

                    select.on('change', function () {
                        const ville = $(this).val();
                        if (ville) {
                            params.set("ville", ville);
                        } else {
                            params.delete("ville");
                        }
                        window.location.search = params.toString();
                    });

                } catch (error) {
                    console.error("Erreur lors du chargement des villes :", error);
                }
            });
        </script>
    </div>
{% endblock %}
